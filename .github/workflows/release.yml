name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install uv
      uses: astral-sh/setup-uv@v1
      with:
        version: latest

    - name: Install dependencies
      run: |
        uv sync --extra dev

    - name: Run framework tests
      run: |
        uv run python tests/test_workflow.py

    - name: Run validation tests
      run: |
        uv run python tests/test_validation.py

    - name: Test all scripts
      run: |
        uv run python tests/test_add_tool.py
        uv run python tests/test_remove_tool.py

    - name: Validate setup
      run: |
        uv run python scripts/validate_setup.py

    - name: Check template integrity
      run: |
        uv run python -c "import yaml; from pathlib import Path; meta = yaml.safe_load(open('configs/meta.yaml')); assert 'tools' in meta, 'Missing tools section'; assert 'experiment' in meta, 'Missing experiment section'; config = yaml.safe_load(open('configs/example_experiment.yaml')); assert 'tool' in config, 'Missing tool field'; assert 'experiment' in config, 'Missing experiment field'; required_dirs = ['configs', 'scripts', 'tests', 'tools', 'outputs', 'notebooks']; [assert Path(dir_name).exists() for dir_name in required_dirs]; required_scripts = ['scripts/add_tool.py', 'scripts/remove_tool.py', 'scripts/run_experiment', 'scripts/validate_setup.py', 'scripts/cleanup_wandb.py']; [assert Path(script_path).exists() for script_path in required_scripts]; print('âœ… Template integrity check passed')"

  create-release:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## ðŸŽ‰ ExperimentStash Template Release

          This release includes:
          - âœ… Framework scripts for tool management
          - âœ… Robust experiment execution with error handling
          - âœ… Signal handling for SLURM environments
          - âœ… Comprehensive documentation and troubleshooting
          - âœ… Validation and testing infrastructure
          - âœ… Clean template structure for collaboration

          ## ðŸš€ Quick Start

          ```bash
          # Clone the template
          git clone <your-repo-url>
          cd experimentstash

          # Add your first tool
          python3 scripts/add_tool.py <tool-name> <github-url>

          # Create an experiment
          # Edit configs/example_experiment.yaml

          # Run the experiment
          python3 scripts/run_experiment <tool> <config>
          ```

          ## ðŸ“š Documentation

          See the [README.md](README.md) for comprehensive documentation.
        draft: false
        prerelease: false
